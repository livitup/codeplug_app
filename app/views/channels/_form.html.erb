<% system_modes = @systems.each_with_object({}) { |s, h| h[s.id] = s.mode } %>
<% system_talk_groups_json = @system_talk_groups_by_system.transform_values { |stgs| stgs.map { |stg| { id: stg.id, name: "#{stg.talk_group.name} (TS#{stg.timeslot || 'N/A'})" } } }.to_json %>

<%= form_with model: [ @codeplug, channel ], local: true do |f| %>
  <% if channel.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(channel.errors.count, "error") %> prohibited this channel from being saved:</h5>
      <ul>
        <% channel.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <h5 class="mb-3">Channel Names</h5>
  <div class="row">
    <div class="col-md-4 mb-3">
      <%= f.label :name, class: "form-label" %>
      <%= f.text_field :name, class: "form-control", required: true, placeholder: "e.g., RPT1" %>
      <div class="form-text">Required channel name</div>
    </div>

    <div class="col-md-4 mb-3">
      <%= f.label :long_name, class: "form-label" %>
      <%= f.text_field :long_name, class: "form-control", placeholder: "e.g., Repeater 1" %>
      <div class="form-text">Long name for radios that support it</div>
    </div>

    <div class="col-md-4 mb-3">
      <%= f.label :short_name, class: "form-label" %>
      <%= f.text_field :short_name, class: "form-control", placeholder: "e.g., RPT1" %>
      <div class="form-text">Short name for radios with limited display</div>
    </div>
  </div>

  <h5 class="mt-4 mb-3">System Configuration</h5>
  <div class="row" id="system-configuration" data-system-modes="<%= system_modes.to_json %>" data-system-talk-groups="<%= system_talk_groups_json %>">
    <div class="col-md-6 mb-3">
      <%= f.label :system_id, "System", class: "form-label" %>
      <%= f.collection_select :system_id, @systems, :id, :name,
          { prompt: "Select a system" },
          { class: "form-select", required: true, id: "channel_system_id" } %>
      <div class="form-text">Select the system/repeater this channel uses</div>
    </div>

    <div class="col-md-6 mb-3" id="talkgroup-field" style="display: <%= channel.system&.mode == 'analog' || channel.system.nil? ? 'none' : 'block' %>;">
      <%= f.label :system_talk_group_id, "Talkgroup (Digital Only)", class: "form-label" %>
      <%= f.collection_select :system_talk_group_id, @system_talk_groups, :id, ->(stg) { "#{stg.talk_group.name} (TS#{stg.timeslot || 'N/A'})" },
          { prompt: "Select a talkgroup", include_blank: true },
          { class: "form-select", id: "channel_system_talk_group_id" } %>
      <div class="form-text">Required for digital modes (DMR, P25)</div>
    </div>
  </div>

  <h5 class="mt-4 mb-3">Channel Settings</h5>
  <div class="row">
    <div class="col-md-6 mb-3">
      <%= f.label :power_level, class: "form-label" %>
      <%= f.select :power_level,
          [ "High", "Medium", "Low" ],
          { prompt: "Select power level", include_blank: true },
          { class: "form-select" } %>
      <div class="form-text">Transmit power level</div>
    </div>

    <div class="col-md-6 mb-3">
      <%= f.label :bandwidth, class: "form-label" %>
      <%= f.select :bandwidth, Channel::BANDWIDTHS,
          { prompt: "Select bandwidth", include_blank: true },
          { class: "form-select" } %>
      <div class="form-text">Override system bandwidth (optional)</div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= f.label :tone_mode, class: "form-label" %>
      <%= f.select :tone_mode,
          [
            ["None", "none"],
            ["TX Only (Encode)", "tx_only"],
            ["RX Only (Decode)", "rx_only"],
            ["TX/RX (Encode & Decode)", "tx_rx"]
          ],
          { prompt: "Select tone mode" },
          { class: "form-select", required: true } %>
      <div class="form-text">CTCSS/DCS tone usage</div>
    </div>

    <div class="col-md-6 mb-3">
      <%= f.label :transmit_permission, class: "form-label" %>
      <%= f.select :transmit_permission,
          [
            ["RX/TX", "allow"],
            ["RX Only", "forbid_tx"]
          ],
          { prompt: "Select permission" },
          { class: "form-select", required: true } %>
      <div class="form-text">Allow or forbid transmission</div>
    </div>
  </div>

  <div class="d-flex gap-2 mt-4">
    <%= f.submit class: "btn btn-primary" %>
    <%= link_to "Cancel", channel.persisted? ? codeplug_channel_path(@codeplug, channel) : codeplug_channels_path(@codeplug), class: "btn btn-secondary" %>
  </div>
<% end %>

<script>
  // Show/hide talkgroup field and filter options based on selected system
  document.addEventListener('turbo:load', function() {
    const systemSelect = document.querySelector('#channel_system_id');
    if (!systemSelect) return; // Exit if not on channel form

    const talkgroupField = document.querySelector('#talkgroup-field');
    const talkgroupSelect = document.querySelector('#channel_system_talk_group_id');
    const systemConfigEl = document.querySelector('#system-configuration');
    if (!talkgroupField || !systemConfigEl || !talkgroupSelect) return;

    const systemModes = JSON.parse(systemConfigEl.dataset.systemModes || '{}');
    const systemTalkGroups = JSON.parse(systemConfigEl.dataset.systemTalkGroups || '{}');

    // Store the currently selected talkgroup to preserve it if possible
    let currentTalkgroupId = talkgroupSelect.value;

    function updateTalkgroupField() {
      const selectedSystemId = systemSelect.value;

      if (!selectedSystemId) {
        // No system selected - hide talkgroup field
        talkgroupField.style.display = 'none';
        return;
      }

      const mode = systemModes[selectedSystemId];
      if (mode === 'analog') {
        talkgroupField.style.display = 'none';
        return;
      }

      // Show field for digital modes
      talkgroupField.style.display = 'block';

      // Filter talkgroup options based on selected system
      const availableTalkgroups = systemTalkGroups[selectedSystemId] || [];

      // Clear and rebuild talkgroup options
      talkgroupSelect.innerHTML = '';

      // Add prompt option
      const promptOption = document.createElement('option');
      promptOption.value = '';
      promptOption.textContent = 'Select a talkgroup';
      talkgroupSelect.appendChild(promptOption);

      // Add blank option (for optional selection)
      const blankOption = document.createElement('option');
      blankOption.value = '';
      blankOption.textContent = '';
      talkgroupSelect.appendChild(blankOption);

      // Add available talkgroups
      availableTalkgroups.forEach(function(tg) {
        const option = document.createElement('option');
        option.value = tg.id;
        option.textContent = tg.name;
        // Preserve selection if the talkgroup is still available
        if (tg.id.toString() === currentTalkgroupId) {
          option.selected = true;
        }
        talkgroupSelect.appendChild(option);
      });
    }

    // Run on page load
    updateTalkgroupField();

    // Run when system dropdown changes
    systemSelect.addEventListener('change', function() {
      // Reset current talkgroup when system changes
      currentTalkgroupId = '';
      updateTalkgroupField();
    });
  });
</script>
