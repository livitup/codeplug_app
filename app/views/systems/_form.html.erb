<%= form_with model: system do |f| %>
  <% if system.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(system.errors.count, "error") %> prohibited this system from being saved:</h5>
      <ul>
        <% system.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= f.label :name, class: "form-label" %>
      <%= f.text_field :name, class: "form-control", required: true, placeholder: "e.g., W4ABC Repeater" %>
      <div class="form-text">System identifier or repeater callsign</div>
    </div>

    <div class="col-md-6 mb-3">
      <%= f.label :mode, class: "form-label" %>
      <%= f.select :mode, System::MODES,
          { prompt: "Select mode" },
          { class: "form-select", required: true } %>
      <div class="form-text">Radio mode (analog, dmr, p25, nxdn)</div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= f.label :tx_frequency, "TX Frequency (MHz)", class: "form-label" %>
      <%= f.number_field :tx_frequency, class: "form-control", step: "any", required: true, placeholder: "145.230" %>
      <div class="form-text">Repeater transmit (radio receive)</div>
    </div>

    <div class="col-md-6 mb-3">
      <%= f.label :rx_frequency, "RX Frequency (MHz)", class: "form-label" %>
      <%= f.number_field :rx_frequency, class: "form-control", step: "any", required: true, placeholder: "144.630" %>
      <div class="form-text">Repeater receive (radio transmit)</div>
    </div>
  </div>

  <div class="mb-3">
    <%= f.label :bandwidth, class: "form-label" %>
    <%= f.text_field :bandwidth, class: "form-control", placeholder: "e.g., 25kHz, 12.5kHz" %>
    <div class="form-text">Default bandwidth (optional)</div>
  </div>

  <h5 class="mt-4 mb-3">Tone Settings</h5>

  <div class="row">
    <div class="col-md-6 mb-3">
      <div class="form-check">
        <%= f.check_box :supports_tx_tone, class: "form-check-input" %>
        <%= f.label :supports_tx_tone, "Supports TX Tone", class: "form-check-label" %>
      </div>
      <%= f.text_field :tx_tone_value, class: "form-control mt-2", placeholder: "e.g., 127.3 or 065" %>
      <div class="form-text">CTCSS or DCS tone value</div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="form-check">
        <%= f.check_box :supports_rx_tone, class: "form-check-input" %>
        <%= f.label :supports_rx_tone, "Supports RX Tone", class: "form-check-label" %>
      </div>
      <%= f.text_field :rx_tone_value, class: "form-control mt-2", placeholder: "e.g., 127.3 or 065" %>
      <div class="form-text">CTCSS or DCS tone value</div>
    </div>
  </div>

  <h5 class="mt-4 mb-3">Location (Optional)</h5>

  <div class="row">
    <div class="col-md-4 mb-3">
      <%= f.label :city, class: "form-label" %>
      <%= f.text_field :city, class: "form-control", placeholder: "Richmond" %>
    </div>

    <div class="col-md-4 mb-3">
      <%= f.label :state, class: "form-label" %>
      <%= f.text_field :state, class: "form-control", placeholder: "Virginia" %>
    </div>

    <div class="col-md-4 mb-3">
      <%= f.label :county, class: "form-label" %>
      <%= f.text_field :county, class: "form-control", placeholder: "Henrico" %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= f.label :latitude, class: "form-label" %>
      <%= f.number_field :latitude, class: "form-control", step: "any", placeholder: "37.5407" %>
    </div>

    <div class="col-md-6 mb-3">
      <%= f.label :longitude, class: "form-label" %>
      <%= f.number_field :longitude, class: "form-control", step: "any", placeholder: "-77.4360" %>
    </div>
  </div>

  <h5 class="mt-4 mb-3">Mode-Specific Settings</h5>

  <!-- DMR Mode Fields -->
  <div id="dmr-fields" class="mode-fields" style="display: none;">
    <div class="mb-3">
      <%= f.label :color_code, "Color Code (0-15)", class: "form-label" %>
      <%= f.number_field :color_code, class: "form-control", min: 0, max: 15, placeholder: "1" %>
      <div class="form-text">DMR color code for this repeater (0-15)</div>
    </div>
  </div>

  <!-- P25 Mode Fields -->
  <div id="p25-fields" class="mode-fields" style="display: none;">
    <div class="mb-3">
      <%= f.label :nac, "NAC (Network Access Code)", class: "form-label" %>
      <%= f.text_field :nac, class: "form-control", placeholder: "$293" %>
      <div class="form-text">P25 Network Access Code (usually in hex format like $293)</div>
    </div>
  </div>

  <!-- Analog Mode Message -->
  <div id="analog-fields" class="mode-fields" style="display: none;">
    <div class="alert alert-info">
      <strong>Analog Mode:</strong> No additional mode-specific settings required.
    </div>
  </div>

  <!-- NXDN Mode Message -->
  <div id="nxdn-fields" class="mode-fields" style="display: none;">
    <div class="alert alert-info">
      <strong>NXDN Mode:</strong> No additional mode-specific settings required.
    </div>
  </div>

  <script>
    // Show/hide mode-specific fields based on selected mode
    document.addEventListener('DOMContentLoaded', function() {
      const modeSelect = document.querySelector('#system_mode');
      const modeFields = document.querySelectorAll('.mode-fields');

      function updateModeFields() {
        const selectedMode = modeSelect.value;

        // Hide all mode-specific fields
        modeFields.forEach(field => field.style.display = 'none');

        // Show the appropriate fields based on selected mode
        if (selectedMode === 'dmr') {
          document.querySelector('#dmr-fields').style.display = 'block';
        } else if (selectedMode === 'p25') {
          document.querySelector('#p25-fields').style.display = 'block';
        } else if (selectedMode === 'analog') {
          document.querySelector('#analog-fields').style.display = 'block';
        } else if (selectedMode === 'nxdn') {
          document.querySelector('#nxdn-fields').style.display = 'block';
        }
      }

      // Run on page load
      updateModeFields();

      // Run when mode changes
      modeSelect.addEventListener('change', updateModeFields);
    });
  </script>

  <div class="d-flex gap-2 mt-4">
    <%= f.submit class: "btn btn-primary" %>
    <%= link_to "Cancel", system.persisted? ? system_path(system) : systems_path, class: "btn btn-secondary" %>
  </div>
<% end %>
